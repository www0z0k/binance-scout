<html>
<head>
<style type="text/css">
  body{
    color:#ffff00;
    background-color:#1D1D1D;
    font-family: monospace;
  }
  .detect {
    width: 23px;
  }
  input[type=number] {
    width: 74px;
  }
  td{
    vertical-align:top;
  }
  canvas{
    /*position: absolute;*/
  }
</style>
</head>
<body>
<span id="pair"></span>
  &nbsp;&nbsp;&nbsp;&nbsp;
  =(^-_-^)=&nbsp;
  candles <input type="number" id="candles-count" class="detect" value="10">
  threshold <input type="number" id="candles-threshold" class="detect" value="2">
  min <input type="number" id="candles-min" class="detect" value="3">
  wall size <input type="number" id="wall-size" class="detect" value="20">
  --> <span id="detect-result"></span>
<span id="connection">
  <input type="text" id="api" placeholder="API KEY"><input type="text" id="secret" placeholder="SECRET">
  <button onclick="sendConnect()">connect</button> 
  depth <input type="number" step="10" value="200" id="depth-lim" onchange="setDepth()">
  candles <input type="number" value="60" id="candles-lim">
</span>
<!-- <div style="position: relative;"> -->
  <canvas id="canv" width="1060" height="550" style="display: none; border:1px solid #ff00ff;"></canvas>
  <canvas id="canv2" width="1060" height="550" style="display: none; border:1px solid #ff00ff; z-index:2;margin-top:-550px;" onmousemove="canvasMove(event)" onmouseout="clearCrosshair()"></canvas>
<!-- </div> -->
<br>
<table style="width: 1060px;">
  <tr>
    <td>
      <span id="balance"></span><br>
      <div id="buyBtns">
        BUY <input type="number" id="b-price"><span id="b-btns"></span><input type="checkbox" id="use-custom-buy"><input type="number" id="b-price-opt"><br>
        SELL <input type="number" id="s-price"><span id="s-btns"></span><input type="checkbox" id="use-custom-sell"><input type="number" id="s-price-opt">
      </div>
      <span id="orders"></span>      
    </td>
    <td>
      <span id="orders-history"></span>      
    </td>
  </tr>  
</table>

<script>
/*
 * Helpers
 */
Number.prototype.toFixed = function(len){
  var parts = this.toString().split('.');
  return parts.length == 1 ? parts[0] : (parts[0] + '.' + parts[1].slice(0, len));
}
Array.prototype.last = function(){
  return this[this.length - 1];
}
HTMLElement.prototype.hide = function(){
  this.style.display = 'none';
}
HTMLElement.prototype.show = function(){
  this.style.display = 'block';
}
HTMLElement.prototype.showInline = function(){
  this.style.display = 'inline';
}
function getByID(id){
  return document.getElementById(id);
}
function valByID(id){
  return document.getElementById(id).value;
}

/*
 * Init
 */
getByID('buyBtns').hide();
getByID('connection').hide();


var BOTTOM_OFFSET = 100;
var DELIMITER_X = 400;
var SCALE_WIDTH = 60;

var canvas = document.getElementById("canv");
var canvasTop = document.getElementById("canv2");
var ctx = canvas.getContext('2d');
var WIDTH = canvas.width;
var HEIGHT = canvas.height;
var DRAW_BOTTOM = HEIGHT - BOTTOM_OFFSET;
canvasTop.show();

/*
 * Crosshair
 */
var dirty = false;
setInterval(el => {
  let ctx = canvasTop.getContext('2d');
  // if(CROSSHAIR.x > -1 && CROSSHAIR.y > -1){
  if(dirty){
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
    ctx.beginPath();
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#ffffff';
    ctx.moveTo(0, CROSSHAIR.y);
    ctx.lineTo(WIDTH, CROSSHAIR.y);
    ctx.moveTo(CROSSHAIR.x, 0);
    ctx.lineTo(CROSSHAIR.x, HEIGHT);
    ctx.stroke();
    ctx.closePath();
    dirty = false;
  }
}, 33)
var CROSSHAIR = {x: -1, y: -1};
function canvasMove(e){
  CROSSHAIR = {x: e.offsetX, y: e.offsetY};
  dirty = true;
}

function clearCrosshair(){
  let ctx = canvasTop.getContext('2d');
  ctx.clearRect(0, 0, WIDTH, HEIGHT);
  dirty = false;
  // CROSSHAIR = {x: -1, y: -1};
  // let ctx = canvasTop.getContext('2d');
  // ctx.clearRect(0, 0, WIDTH, HEIGHT);
}
/*
 * Main display
 */
function drawAll(buys, sells, candles, startPrice, pair){
  if(!buys.length || !sells.length){
    return
  }
  canvas.show();

  ctx.beginPath();
  ctx.fillStyle = '#1D1D1D';
  ctx.rect(0, 0, WIDTH, HEIGHT);
  ctx.fill();
  ctx.closePath();
  ctx.beginPath();
  ctx.fillStyle = '#1D1D15';
  ctx.rect(0, DRAW_BOTTOM + 5, WIDTH, HEIGHT);
  ctx.fill();
  ctx.closePath();


  var maxCandle = 0;
  var minCandle = 0;
  var maxVolume = 0;
  candles.forEach(el => {
    maxCandle = maxCandle ? (maxCandle < el.high ? el.high : maxCandle) : el.high;
    minCandle = minCandle ? (minCandle > el.low ? el.low : minCandle) : el.low;
    maxVolume = maxVolume < el.volume ? el.volume : maxVolume;
  });
  var dPriceBuy = buys[0].price - buys.last().price;
  var dPriceSell = sells.last().price - sells[0].price;

  var dSum = Math.max(buys.last().sum, sells.last().sum);

  var absMin = Math.min(sells[0].price, buys.last().price, minCandle)
  var absMax = Math.max(buys[0].price, sells.last().price, maxCandle)

  var dPrice = absMax - absMin;

  function getPriceY(pr){
    return DRAW_BOTTOM - DRAW_BOTTOM * (pr - absMin) / (absMax - absMin);
  }

  var priceY = getPriceY(candles.last().close);

  var wallsCenterY = priceY;
  var wallPriceScale = DRAW_BOTTOM / dPrice;
  var wallVolScale = DELIMITER_X / dSum;

  //Delimiter
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(180, 180, 180, 1)';
  ctx.lineWidth = 0.3;
  ctx.moveTo(DELIMITER_X, 0);
  ctx.lineTo(DELIMITER_X, HEIGHT);

  var scaleStep = 10;
  if(dPrice > 499){
    scaleStep = 100;
  }else if(dPrice > 250){
    scaleStep = 40;
  }

  for(var i = Math.ceil(absMin / 10) * 10; i < absMax; i += scaleStep){
    ctx.moveTo(DELIMITER_X + SCALE_WIDTH, getPriceY(i));
    ctx.lineTo(WIDTH, getPriceY(i));
    ctx.fillStyle = 'green';
    ctx.font = '11px monospace';
    ctx.fillText(i, DELIMITER_X + 20, getPriceY(i) + 1);
  }

  ctx.stroke();
  ctx.closePath();

  ctx.lineWidth = 1;

  /*
   * Red / Bottom / Buy wall
   */
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(255, 0, 0, 1)';
  ctx.fillStyle = 'rgba(255, 0, 0, 0.4)';
  ctx.moveTo(DELIMITER_X, wallsCenterY);
  var lastBottomY = 0;
  for (var i = 0; i < buys.length; i++) {
    lastBottomY = getPriceY(buys[i].price);
    var x = DELIMITER_X - buys[i].sum * wallVolScale;
    ctx.lineTo(x, lastBottomY);
  }
  ctx.lineTo(DELIMITER_X, lastBottomY);
  ctx.fill();
  ctx.stroke();
  ctx.closePath();

   
  /*
   * Green / Top / Sell wall
   */
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(0, 255, 0, 1)';
  ctx.fillStyle = 'rgba(0, 255, 0, 0.4)';
  ctx.moveTo(DELIMITER_X, wallsCenterY);

  var lastTopY = 0;
  for (var i = 0; i < sells.length; i++) {
    lastTopY = getPriceY(sells[i].price);
    var x = DELIMITER_X - sells[i].sum * wallVolScale;
    ctx.lineTo(x, lastTopY);
  }
  ctx.lineTo(DELIMITER_X, lastTopY);
  ctx.fill();
  ctx.stroke();
  ctx.closePath();


   
  /*
   * Candles
   */
  var space = 6;
  var candleWidth = (WIDTH - SCALE_WIDTH - DELIMITER_X) / candles.length - space;

  var priceScale = DRAW_BOTTOM / dPrice;

  candles.forEach((el, i) => {
    ctx.beginPath();
    ctx.strokeStyle = el.bull ? 'rgba(0, 255, 0, 1)' : 'rgba(255, 0, 0, 1)';
    ctx.fillStyle = el.bull ? 'rgba(0, 255, 0, 0.4)' : 'rgba(255, 0, 0, 0.4)';

    var startX = DELIMITER_X + SCALE_WIDTH + i * (space + candleWidth) + space / 2;
    var centerX = startX + candleWidth / 2;

    ctx.moveTo(centerX, getPriceY(el.high));
    ctx.lineTo(centerX, el.bull ? getPriceY(el.close) : getPriceY(el.open));
    ctx.moveTo(centerX, el.bull ? getPriceY(el.open) : getPriceY(el.close));
    ctx.lineTo(centerX, getPriceY(el.low));

    ctx.rect(startX, getPriceY(Math.max(el.open, el.close)), candleWidth, Math.abs(el.close - el.open) * priceScale);
    //volume - test
    ctx.rect(startX, HEIGHT, candleWidth, -(BOTTOM_OFFSET - 10) * el.volume / maxVolume);

    ctx.fill();
    ctx.stroke();
    ctx.closePath();
  });
   

  /*
   * Captions
   */
   
  ctx.fillStyle = 'yellow';
  ctx.font = '13px monospace';

  ctx.fillText('vol ' + dSum.toFixed(2), 0, 10);

  //depth scale
  ctx.fillText(buys.last().price.toFixed(2), DELIMITER_X, lastBottomY + 10);
  ctx.fillText(sells.last().price.toFixed(2), DELIMITER_X, lastTopY + 10);

  //candles scale
  ctx.fillText(maxCandle.toFixed(2), DELIMITER_X, getPriceY(maxCandle) + 10);
  ctx.fillText(minCandle.toFixed(2), DELIMITER_X, getPriceY(minCandle) + 10);
  ctx.fillText('max vol', DELIMITER_X, HEIGHT - 50);
  ctx.fillText(maxVolume.toFixed(2), DELIMITER_X, HEIGHT - 30);

  //curr price
  ctx.strokeStyle = 'rgba(0, 125, 125, 1)';
  ctx.fillStyle = 'rgba(0, 125, 125, 1)';

  ctx.fillText(candles.last().close.toFixed(2), DELIMITER_X, priceY + 5);
  ctx.beginPath();
  ctx.moveTo(WIDTH, priceY);
  ctx.lineTo(DELIMITER_X + SCALE_WIDTH, priceY);
  ctx.stroke();
  ctx.closePath();

  document.getElementById('pair').innerHTML = pair;
}


/*
 * Detector test
 */
function detectTest(buys, sells, candles, price){
  let count = valByID('candles-count');
  let min = valByID('candles-min');
  let threshold = valByID('candles-threshold');
  let wall = valByID('wall-size');

  let c = candles.slice(candles.length - count);
  c.sort((a, b) => {return b.high - a.high});
  let passed = true;
  let fits = [];
  for (var i = 0; i < min; i++) {
    if(c[0].high - c[i].high > threshold){
      // console.log(`${c[0].high} - ${c[i].high} > ${threshold}`);
      getByID('detect-result').innerHTML = 'no (candles)';
      return;
    }
    fits.push(c[i].high);
  }
  
  let avg = fits.reduce((a,b) => a + b, 0) / fits.length;
  // console.log(avg);
  // console.log(c);
  for (var i = 0; i < sells.length; i++) {
    if(sells[i].price > avg && sells[i].sum < wall){
      // console.log(`${sells[i].price} > ${avg} && ${sells[i].sum} < ${wall}`);
      getByID('detect-result').innerHTML = 'no (walls)';
      return;
    }
  }
  getByID('detect-result').innerHTML = `should be ${avg}`;
  // console.log(`should be it @ ${avg}`);
}

/*
 * Helpers
 */
function createSellButton(sum, part, buy, precision, fee){
  let amount = Number((sum * (part - fee)).toFixed(precision));
  return `<button onclick="${buy ? 'buy' : 'sell'}(${amount})">${amount}</button>`;
}

// Create WebSocket connection.
// const socket = new WebSocket('ws://127.0.0.1:3003');
const socket = new WebSocket(`ws://${location.hostname}:3003`);

// Connection opened
socket.addEventListener('open', function (event) {
    socket.send('connected');
    getByID('connection').show();
});

// Listen for messages
socket.addEventListener('message', function (event) {
  let res = JSON.parse(event.data);
  window.document.title = res.price.toFixed(2);
  drawAll(res.walls.buy, res.walls.sell, res.candles.slice(res.candles.length - valByID('candles-lim')), res.price, res.pair);
  
  detectTest(res.walls.buy, res.walls.sell, res.candles.slice(res.candles.length - valByID('candles-lim')), res.price);

  getByID('b-price').value = res.price + 1;
  getByID('s-price').value = res.price - 1;

  if(res.balances){
    getByID('buyBtns').show();
    getByID('balance').innerHTML = '';
    for(let c in res.balances){
      let avail = res.balances[c].avail;
      getByID('balance').innerHTML += c + ' : avail ' + avail + ',  order ' + res.balances[c].ordered + '<br>';
      if(c == 'BTC'){
        getByID('s-btns').innerHTML = createSellButton(avail, 0.25, false, 6, 0) 
                                        + createSellButton(avail, 0.5, false, 6, 0) 
                                        + createSellButton(avail, 0.75, false, 6, 0) 
                                        + createSellButton(avail, 1, false, 6, 0);
      }else if(c == 'USDT'){
        getByID('b-btns').innerHTML = createSellButton(avail, 0.25, true, 2, 0) 
                                        + createSellButton(avail, 0.5, true, 2, 0) 
                                        + createSellButton(avail, 0.75, true, 2, 0) 
                                        + createSellButton(avail, 1, true, 2, 0);
      }
    }
  }
  if(res.orders){
    getByID('orders').innerHTML = '';
    for (var i = 0; i < res.orders.sell.length; i++) {
      let order = res.orders.sell[i];
      getByID('orders').innerHTML += ' SELL : ' + order.origQty + ' [ ' + (order.price * order.origQty).toFixed(3) + ' ] | price : ' + order.price.toFixed(2) + ' ID: ' + order.orderId + '<button onclick="cancelOrder(' + order.orderId +')">x</button><br>'; 
    }
    for (var i = 0; i < res.orders.buy.length; i++) {
      let order = res.orders.buy[i];
      getByID('orders').innerHTML += ' BUY : ' + order.origQty + ' [ ' + (order.price * order.origQty).toFixed(3) + ' ] | price : ' + order.price.toFixed(2) + ' ID: ' + order.orderId + '<button onclick="cancelOrder(' + order.orderId +')">x</button><br>'; 
    }
  }
  if(res.ordersOld){
    getByID('orders-history').innerHTML = '';
    res.ordersOld.reverse();
    for (var i = 0; i < res.ordersOld.length; i++) {
      getByID('orders-history').innerHTML += res.ordersOld[i].side + ', ' + res.ordersOld[i].origQty + '[' + res.ordersOld[i].cummulativeQuoteQty + '], price ' + res.ordersOld[i].price.toFixed(2) + '<br>';
    }
  }
});

socket.onclose = function(event) {
  if (event.wasClean) {
    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
  } else {
    // e.g. server process killed or network down
    // event.code is usually 1006 in this case
    console.log('[close] Connection died');
  }
  location.reload();
};

socket.onerror = function(error) {
  console.log(`[error] ${error.message}`);
  location.reload();
};

/*
 * Custom handlers
 */
if(document.cookie){
  let k = document.cookie.split('keys=')[1];
  getByID('api').value = k.split('|')[0];
  getByID('secret').value = k.split('|')[1];
}

function sendConnect(){
  document.cookie = 'keys=' + valByID('api') + '|' + valByID('secret');
  socket.send(`{"action": "login", "key":"${valByID('api')}", "secret":"${valByID('secret')}"}`);
}
function cancelOrder(id){
  socket.send('{"action": "cancelOrder", "id": ' + id + '}');
}
function setDepth(){
  socket.send('{"action": "depths-limits", "value": ' + valByID('depth-lim') + '}');
}
function sell(amount){
  let price = (getByID('use-custom-sell').checked && !isNaN(valByID('s-price-opt'))) ? Number(valByID('s-price-opt')) : Number(valByID('s-price'));
  socket.send(JSON.stringify({
    "action": "sell",
    amount,
    price: Number(price.toFixed(2))
  }));
}
function buy(amount){
  //NB: buy amount in USDT, convert it!
  let price = (getByID('use-custom-buy').checked && !isNaN(valByID('b-price-opt'))) ? Number(valByID('b-price-opt')) : Number(valByID('b-price'));
  socket.send(JSON.stringify({
    "action": "buy",
    amount: Number((amount / price).toFixed(6)),
    price: Number(price.toFixed(2))
  }));
}

</script></body></html>